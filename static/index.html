<!DOCTYPE html>
<html>
	<head>
		<title>WebRTC Streaming</title>
		<style>
			.container {
				max-width: 800px;
				margin: 0 auto;
				padding: 20px;
			}
			video {
				width: 100%;
				background: #000;
			}
			.controls {
				margin-top: 20px;
			}
			button {
				padding: 10px 20px;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<video id="video" autoplay playsinline></video>
			<div class="controls">
				<button id="startButton">Start</button>
				<button id="stopButton" disabled>Stop</button>
				<span id="status">Disconnected</span>
			</div>
		</div>

		<script>
			// Get DOM elements
			const video = document.getElementById("video");
			const startButton = document.getElementById("startButton");
			const stopButton = document.getElementById("stopButton");
			const statusElement = document.getElementById("status");

			// Global variables
			let pc = null;
			let ws = null;
			let stream = null;

			// Helper function to update status
			function updateStatus(message, color = "black") {
				console.log("Status:", message);
				statusElement.textContent = message;
				statusElement.style.color = color;
			}

			// WebRTC configuration
			const config = {
				iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
			};

			async function startBroadcast() {
				try {
					// First get user media
					stream = await navigator.mediaDevices.getUserMedia({
						video: true,
						audio: true,
					});

					// Show stream in video element
					video.srcObject = stream;

					// Create peer connection
					pc = new RTCPeerConnection(config);

					// Add tracks to peer connection
					stream.getTracks().forEach((track) => {
						pc.addTrack(track, stream);
					});

					// Create offer
					const offer = await pc.createOffer();
					await pc.setLocalDescription(offer);

					// Create WebSocket connection
					ws = new WebSocket("ws://147.182.138.79:8080/broadcast");

					ws.onopen = () => {
						console.log("WebSocket connected");
						updateStatus("Connected");

						// Send offer once connected
						ws.send(
							JSON.stringify({
								type: "offer",
								sdp: offer.sdp,
								streamKey: "your-stream-key",
							})
						);
					};

					ws.onclose = () => {
						console.log("WebSocket closed");
						updateStatus("Disconnected", "red");
					};

					ws.onerror = (error) => {
						console.error("WebSocket error:", error);
						updateStatus("Connection failed", "red");
					};

					ws.onmessage = async (e) => {
						try {
							const msg = JSON.parse(e.data);
							if (msg.type === "answer") {
								await pc.setRemoteDescription(
									new RTCSessionDescription({
										type: "answer",
										sdp: msg.sdp,
									})
								);
								updateStatus("Broadcasting", "green");
							}
						} catch (error) {
							console.error("Error handling message:", error);
							updateStatus("Error: " + error.message, "red");
						}
					};

					// Update UI
					startButton.disabled = true;
					stopButton.disabled = false;
				} catch (error) {
					console.error("Error:", error);
					updateStatus("Error: " + error.message, "red");
					stop();
				}
			}

			function stop() {
				if (stream) {
					stream.getTracks().forEach((track) => track.stop());
				}
				if (pc) {
					pc.close();
				}
				if (ws) {
					ws.close();
				}

				video.srcObject = null;
				startButton.disabled = false;
				stopButton.disabled = true;
				updateStatus("Disconnected");
			}

			// Event listeners
			startButton.addEventListener("click", startBroadcast);
			stopButton.addEventListener("click", stop);
		</script>
	</body>
</html>
