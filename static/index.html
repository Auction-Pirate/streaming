<!DOCTYPE html>
<html>
	<head>
		<title>WebRTC Streaming</title>
		<style>
			.container {
				max-width: 800px;
				margin: 0 auto;
				padding: 20px;
			}
			video {
				width: 100%;
				background: #000;
			}
			.controls {
				margin-top: 20px;
			}
			button {
				padding: 10px 20px;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<video id="video" autoplay playsinline></video>
			<div class="controls">
				<button id="startButton">Start</button>
				<button id="stopButton" disabled>Stop</button>
			</div>
		</div>

		<script>
			const video = document.getElementById("video");
			const startButton = document.getElementById("startButton");
			const stopButton = document.getElementById("stopButton");

			let pc;
			let ws;
			let stream;

			async function startBroadcast() {
				try {
					// Log the start of the process
					console.log("Starting broadcast...");

					// Create WebSocket first to test connection
					ws = new WebSocket("ws://147.182.138.79:8080/broadcast");

					ws.onerror = (error) => {
						console.error("WebSocket connection failed:", error);
						updateStatus("WebSocket connection failed", "#f44336");
					};

					ws.onopen = async () => {
						console.log("WebSocket connected successfully");

						try {
							// Get user media
							stream = await navigator.mediaDevices.getUserMedia({
								video: true,
								audio: true,
							});
							console.log("Got media stream:", stream);

							// Create peer connection
							pc = new RTCPeerConnection({
								iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
							});
							console.log("Created peer connection");

							// Add tracks
							stream.getTracks().forEach((track) => {
								console.log("Adding track:", track.kind);
								pc.addTrack(track, stream);
							});

							// Create offer
							const offer = await pc.createOffer();
							console.log("Created offer");
							await pc.setLocalDescription(offer);
							console.log("Set local description");

							// Send offer
							ws.send(
								JSON.stringify({
									type: "offer",
									sdp: offer.sdp,
									streamKey: "your-stream-key",
								})
							);
							console.log("Sent offer");

							// Show stream in video element
							const videoElement = document.getElementById("video");
							videoElement.srcObject = stream;
							await videoElement.play();
							console.log("Playing local video");

							startButton.disabled = true;
							stopButton.disabled = false;
							updateStatus("Broadcasting", "#4CAF50");
						} catch (error) {
							console.error("Error in broadcast setup:", error);
							updateStatus("Error: " + error.message, "#f44336");
							stopBroadcast();
						}
					};
				} catch (error) {
					console.error("Error starting broadcast:", error);
					updateStatus("Error: " + error.message, "#f44336");
				}
			}

			function stop() {
				if (stream) {
					stream.getTracks().forEach((track) => track.stop());
				}
				if (pc) {
					pc.close();
				}
				if (ws) {
					ws.close();
				}
				video.srcObject = null;
				startButton.disabled = false;
				stopButton.disabled = true;
			}

			startButton.onclick = startBroadcast;
			stopButton.onclick = stop;

			// Add this before any WebSocket connection attempt
			async function testWebSocket() {
				try {
					const ws = new WebSocket("ws://147.182.138.79:8080/broadcast");

					ws.onopen = () => {
						console.log("WebSocket connection successful");
						ws.close();
					};

					ws.onerror = (error) => {
						console.error("WebSocket connection failed:", error);
					};
				} catch (error) {
					console.error("WebSocket test failed:", error);
				}
			}

			// Call this when the page loads
			testWebSocket();
		</script>
	</body>
</html>
